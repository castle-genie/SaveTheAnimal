<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.spring.report.dao.ReportDao">
	<resultMap type="report" id="reportMap">
		<id column="report_id" property="reportId"/>
		<result column="report_sort" property="reportSort"/>
		<result column="report_date" property="reportDate"/>
		<result column="report_detail" property="reportDetail"/>
		<result column="report_status" property="reportStatus"/>
		
		<result column="user_id" property="userId"/>
		<result column="fboard_id" property="fboardId"/>
		<result column="vfboard_id" property="vfboardId"/>
		<result column="afboard_id" property="afboardId"/>
		<result column="fcomment_id" property="fcommentId"/>
		<result column="vfcomment_id" property="vfcommentId"/>
		<result column="afcomment_id" property="afcommentId"/>
		<result column="user_repcnt" property="repcnt"/>
	</resultMap>

	<!-- 	reportList.jsp 출력을 위한 select 문
			case when 문을 통해 report table에 id를 가지고 있는 콘텐츠의 정보를 select 한다.
			report table 뿐만 아니라 신고 기능이 있는 6가지 콘텐츠 테이블을 조인해 조회한다.
			where 조건문에서도 or 연산자를 통해 각 콘텐츠 테이블의 아이디 유무를 확인한다.
			또한 where절에서 report_id를 1로 규정해 이미 제재 처리된 신고 콘텐츠는 표시하지 않는다.	-->
	<select id="reportList" parameterType="report" resultMap="reportMap">
		select distinct r.report_id, r.report_sort, to_char(r.report_date, 'YYYY-MM-DD') as report_date, r.report_status,
		    r.user_id, r.fboard_id, r.vfboard_id, r.afboard_id, r.fcomment_id, r.vfcomment_id, r.afcomment_id ,
		    case
		        when r.fboard_id is not null then f.fboard_title
		        when r.vfboard_id is not null then v.vfboard_title
		        when r.afboard_id is not null then a.afboard_title
		        when r.fcomment_id is not null then fc.fcomment_content
		        when r.vfcomment_id is not null then vc.vfcomment_content
		        when r.afcomment_id is not null then ac.afcomment_content
		    end as boardTitle,
		    case
		        when r.fboard_id is not null then to_char(f.fboard_date, 'YYYY-MM-DD')
		        when r.vfboard_id is not null then to_char(v.vfboard_date, 'YYYY-MM-DD')
		        when r.afboard_id is not null then to_char(a.afboard_date, 'YYYY-MM-DD')
		        when r.fcomment_id is not null then to_char(fc.fcomment_date, 'YYYY-MM-DD')
		        when r.vfcomment_id is not null then to_char(vc.vfcomment_date, 'YYYY-MM-DD')
		        when r.afcomment_id is not null then to_char(ac.afcomment_date, 'YYYY-MM-DD')
		    end as boardDate,
		    case
		        when r.fboard_id is not null then f.user_id
		        when r.vfboard_id is not null then v.user_id
		        when r.afboard_id is not null then a.user_id
		        when r.fcomment_id is not null then fc.user_id
		        when r.vfcomment_id is not null then vc.user_id
		        when r.afcomment_id is not null then ac.user_id
		    end as boardUser
		from report r, freeBoard f, volunteerFeedbackBoard v, adoptionFeedbackBoard a, fcomment fc, vfcomment vc, afcomment ac
		where (r.report_status = 1) and ((r.fboard_id = f.fboard_id) or (r.vfboard_id = v.vfboard_id) or (r.afboard_id = a.afboard_id) or (r.fcomment_id = fc.fcomment_id) or (r.vfcomment_id = vc.vfcomment_id) or (r.afcomment_id = ac.afcomment_id))
	</select>
	
	<!-- 	reportDetail.jsp 출력을 위한 select 문
			case when 문을 통해 report table에 id를 가지고 있는 콘텐츠의 정보를 select 한다.
			report table 뿐만 아니라 신고 기능이 있는 6가지 콘텐츠 테이블을 조인해 조회한다.
			where 조건문에서도 or 연산자를 통해 각 콘텐츠 테이블의 아이디 유무를 확인한다.
			또한 user_repcnt를 users 테이블에서 가져오기 위해 user_id를 users table과 report table에서 비교한다.	-->
	<select id="reportDetail" parameterType="report" resultMap="reportMap">
		select distinct r.report_id, r.report_sort, to_char(r.report_date, 'YYYY-MM-DD') as report_date, r.report_status, r.report_detail,
		    r.user_id, r.fboard_id, r.vfboard_id, r.afboard_id, r.fcomment_id, r.vfcomment_id, r.afcomment_id, u.user_repcnt,
		    case
		        when r.fboard_id is not null then f.fboard_id
		        when r.vfboard_id is not null then v.vfboard_id
		        when r.afboard_id is not null then a.afboard_id
		        when r.fcomment_id is not null then fc.fcomment_id
		        when r.vfcomment_id is not null then vc.vfcomment_id
		        when r.afcomment_id is not null then ac.afcomment_id
		    end as boardId,
		    case
		        when r.fboard_id is not null then f.fboard_title
		        when r.vfboard_id is not null then v.vfboard_title
		        when r.afboard_id is not null then a.afboard_title
		        when r.fcomment_id is not null then fc.fcomment_content
		        when r.vfcomment_id is not null then vc.vfcomment_content
		        when r.afcomment_id is not null then ac.afcomment_content
		    end as boardTitle,
		    case
		        when r.fboard_id is not null then to_char(f.fboard_date, 'YYYY-MM-DD')
		        when r.vfboard_id is not null then to_char(v.vfboard_date, 'YYYY-MM-DD')
		        when r.afboard_id is not null then to_char(a.afboard_date, 'YYYY-MM-DD')
		        when r.fcomment_id is not null then to_char(fc.fcomment_date, 'YYYY-MM-DD')
		        when r.vfcomment_id is not null then to_char(vc.vfcomment_date, 'YYYY-MM-DD')
		        when r.afcomment_id is not null then to_char(ac.afcomment_date, 'YYYY-MM-DD')
		    end as boardDate,
		    case
		        when r.fboard_id is not null then f.user_id
		        when r.vfboard_id is not null then v.user_id
		        when r.afboard_id is not null then a.user_id
		        when r.fcomment_id is not null then fc.user_id
		        when r.vfcomment_id is not null then vc.user_id	
		        when r.afcomment_id is not null then ac.user_id
		    end as boardUser,
		    case
		        when r.fboard_id is not null then f.fboard_content
		        when r.vfboard_id is not null then v.vfboard_content
		        when r.afboard_id is not null then a.afboard_content
		        when r.fcomment_id is not null then fc.fcomment_content
		        when r.vfcomment_id is not null then vc.vfcomment_content
		        when r.afcomment_id is not null then ac.afcomment_content
		    end as boardContent
		from report r, freeBoard f, volunteerFeedbackBoard v, adoptionFeedbackBoard a, fcomment fc, vfcomment vc, afcomment ac, users u
		where ((u.user_id = (select user_id from freeboard where fboard_id = (select fboard_id from report where report_id = #{reportId}))) 
            or (u.user_id = (select user_id from volunteerFeedbackBoard where vfboard_id = (select vfboard_id from report where report_id = #{reportId}))) 
            or (u.user_id = (select user_id from adoptionFeedbackBoard where afboard_id = (select afboard_id from report where report_id = #{reportId}))) 
            or (u.user_id = (select user_id from fcomment where fcomment_id = (select fcomment_id from report where report_id = #{reportId}))) 
            or (u.user_id = (select user_id from vfcomment where vfcomment_id = (select vfcomment_id from report where report_id = #{reportId}))) 
            or (u.user_id = (select user_id from afcomment where afcomment_id = (select afcomment_id from report where report_id = #{reportId})))) 
        and (r.report_id = #{reportId})
        and ((r.fboard_id = f.fboard_id) or (r.vfboard_id = v.vfboard_id) or (r.afboard_id = a.afboard_id) or (r.fcomment_id = fc.fcomment_id) or (r.vfcomment_id = vc.vfcomment_id) or (r.afcomment_id = ac.afcomment_id))
	
	</select>


	<!-- 	신고기능 report table에 신고 정보를 기록하는 기능
			report_id는 시퀀스를 통해 자동생성
			report_sort, report_detail은 report.jsp에서 입력받아 사용
			report_date는 sysdate를 사용
			report status는 기본값 1 사용
			boardId, user_id는 콘텐츠에서 가져오기
			신고버튼을 누른 콘텐츠에 따라 각자 다른 insert 문 사용 				-->
	<insert id="reportInsertFB" parameterType="report">
		insert into report(report_id, report_sort, report_date, report_detail, report_status, fboard_id, user_id)
		values(report_seq.nextval, #{reportSort}, sysdate, #{reportDetail}, 1, #{fboardId}, #{userId})
	</insert>

	<insert id="reportInsertVB" parameterType="report">
		insert into report(report_id, report_sort, report_date, report_detail, report_status, vfboard_id, user_id)
		values(report_seq.nextval, #{reportSort}, sysdate, #{reportDetail}, 1, #{vfboardId}, #{userId})
	</insert>

	<insert id="reportInsertAB" parameterType="report">
		insert into report(report_id, report_sort, report_date, report_detail, report_status, afboard_id, user_id)
		values(report_seq.nextval, #{reportSort}, sysdate, #{reportDetail}, 1, #{afboardId}, #{userId})
	</insert>

	<insert id="reportInsertFC" parameterType="report">
		insert into report(report_id, report_sort, report_date, report_detail, report_status, fcomment_id, user_id)
		values(report_seq.nextval, #{reportSort}, sysdate, #{reportDetail}, 1, #{fcommentId}, #{userId})
	</insert>

	<insert id="reportInsertVC" parameterType="report">
		insert into report(report_id, report_sort, report_date, report_detail, report_status, vfcomment_id, user_id)
		values(report_seq.nextval, #{reportSort}, sysdate, #{reportDetail}, 1, #{vfcommentId}, #{userId})
	</insert>

	<insert id="reportInsertAC" parameterType="report">
		insert into report(report_id, report_sort, report_date, report_detail, report_status, afcomment_id, user_id)
		values(report_seq.nextval, #{reportSort}, sysdate, #{reportDetail}, 1, #{afcommentId}, #{userId})
	</insert>

	<!-- 	신고제재 처리 기능
			관리자가 신고 제재 혹은 무시 처리 할 시 
			report table에 report_status를 2로 변경  -->
	<update id="reportUpdateFB" parameterType="report">
		update report
		set report_status = 2
		where fboard_id = #{boardId}
	</update>
	<update id="reportUpdateVB" parameterType="report">
		update report
		set report_status = 2
		where vfboard_id = #{boardId}
	</update>
	<update id="reportUpdateAB" parameterType="report">
		update report
		set report_status = 2
		where afboard_id = #{boardId}
	</update>
	<update id="reportUpdateFC" parameterType="report">
		update report
		set report_status = 2
		where fcomment_id = #{boardId)}
	</update>
	<update id="reportUpdateVC" parameterType="report">
		update report
		set report_status = 2
		where vfcomment_id = #{boardId)}
	</update>
	<update id="reportUpdateAC" parameterType="report">
		update report
		set report_status = 2
		where afcomment_id = #{boardId)}
	</update>



	<!-- 	신고 수정 기능
			report table에서 report_sort, report_detail 수정 기능
			report_date는 sysdate를 활용해 수정 -->
	<update id="reportModify" parameterType="report">
		update report
		set 
			report_sort = #{reportSort},
			report_date = sysdate,
			report_detail = #{reportDetail}
		where report_id = #{reportId}
	</update>

	<!-- 	신고 취소 기능
			report table에서 report_id를 기준으로 행 삭제	 -->
	<delete id="reportDelete" parameterType="report">
		delete from report
		where report_id = #{reportId}
	</delete>
	
	<!-- 	신고 제재시 회원의 제재 횟수 증가시키는 기능
			users table의 user_repcnt를 1 증가시키기
			reportDetail.jsp에서 sanctionBtn을 click하면 실행됨
			user_id를 기준으로 처리됨							 -->
	<update id="repcntUpdate" parameterType="report">
		update users
			set user_repcnt = user_repcnt + 1
		where user_id = #{boardUser}
	</update>
	
	
	<!-- 신고 제재시 게시물 삭제 기능 -->
	<delete id="contentDeleteFB" parameterType="report">
		delete from freeboard
		where fboard_id = #{boardId}
	</delete>
	<delete id="contentDeleteVB" parameterType="report">
		delete from volunteerFeedbackBoard
		where vfboard_id = #{boardId}
	</delete>
	<delete id="contentDeleteAB" parameterType="report">
		delete from adoptionFeedbackBoard
		where afboard_id = #{boardId}
	</delete>
	<delete id="contentDeleteFC" parameterType="report">
		delete from fcomment
		where fcomment_id = #{boardId}
	</delete>
	<delete id="contentDeleteVC" parameterType="report">
		delete from vfcomment
		where vfcomment_id = #{boardId}
	</delete>
	<delete id="contentDeleteAC" parameterType="report">
		delete from afcomment
		where afcomment_id = #{boardId}
	</delete>
	
	<!-- 신고 제재 시 유저 계정 정지 -->
	<update id="userStop" parameterType="report">
		update users
			set user_act = 2
		where user_id = #{boardUser}
	</update>
	
	<!-- 신고 제재로 정지된 계정 복구 -->
	<update id="userGo" parameterType="report">
		update users
			set user_act = 1
		where user_id = #{boardUser}
	</update>
	
	<!-- 신고 제재 시 유저 계정 삭제 -->
	<delete id="userDelete" parameterType="report">
		delete from users
		where user_id = #{boardUser}
	</delete>
	
	
	

</mapper>